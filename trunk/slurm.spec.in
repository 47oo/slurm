# $Id$

Name: @PROJECT@
Version: @VERSION@
Release: @RELEASE@

Summary: Simple Linux Utility for Resource Management

License: GPL 
Group: System Environment/Base
Source: %{name}-%{version}-%{release}.tgz
Requires: readline popt
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}

#
# Defaults are --with-elan --with-totalview
#
%{!?_with_elan: %{!?_without_elan: %define _with_elan --with-elan}}
%{!?_with_totalview: %{!?_without_totalview: %define _with_totalview --with-totalview}}

%{?_with_elan:BuildRequires: qsnetlibs}

# 
# Don't strip installed binaries for now:
#
%define %__strip ""


%package devel
Summary: Development package for SLURM.
Group: Development/System
Requires: slurm

%package auth-none
Summary: SLURM auth NULL implementation (no authentication)
Group: System Environment/Base
Requires: slurm

%package auth-authd
Summary: SLURM auth implementation using Brent Chun's authd
Group: System Environment/Base
Requires: slurm authd

%package auth-munge
Summary: SLURM auth implementation using Chris Dunlap's Munge
Group: System Environment/Base
Requires: slurm munge

%description 
SLURM is a simple resource management system which manages
exclusive access to a set of compute resources and distrubutes
work to those resources. Included in this package are the SLURM
controller, compute node daemon, and all clients necessary to
access SLURM functionality.

%description devel
Development package for SLURM.  This package includes the header files
and static libraries for the SLURM API.

%description auth-none
SLURM NULL authentication module 

%description auth-authd
SLURM authentication module for Brent Chun's authd

%description auth-munge
SLURM authentication module for Chris Dunlap's Munge

%prep
%setup -n %{name}-%{version}-%{release}

%build
PFX_FIX=--program-prefix=%{?_program_prefix:%{_program_prefix}} 
WITHCONF=--sysconfdir=/etc/slurm

# for now we build with debugging symbols
CFLAGS="-g -Wall"
%configure \
    --enable-debug                       \
    $PFX_FIX $WITHCONF                   \
    %{?_with_elan}                       \
    %{?_without_elan}                    \
    %{?_with_totalview}                  \
    %{?_without_totalview}

make

%install
rm -rf "$RPM_BUILD_ROOT"
mkdir -p "$RPM_BUILD_ROOT"
DESTDIR="$RPM_BUILD_ROOT" make install

install -D -m755 etc/init.d.slurm $RPM_BUILD_ROOT/etc/rc.d/init.d/slurm
install -D -m644 etc/slurm.conf.example $RPM_BUILD_ROOT/etc/slurm/slurm.conf

%clean
rm -rf $RPM_BUILD_ROOT

%files
%defattr(-,root,root,0755)
%doc README 
%doc DISCLAIMER
%doc COPYING
%doc etc/slurm.conf.example
%{_bindir}/*
%{_sbindir}/*
%{_libdir}/*.so*
%{_mandir}/man1/*
%{_mandir}/man5/*
%{_mandir}/man8/*
%config(noreplace) /etc/rc.d/init.d/slurm
%config(noreplace) /etc/slurm/slurm.conf

%files devel
%defattr(-,root,root)
%{_prefix}/include/slurm/*
%{_libdir}/libslurm.a
%{_libdir}/libslurm.la
%{_mandir}/man3/*

%if %(test -f %{_libdir}/slurm/auth_none.so && echo 1 || echo 0)
%files auth-none
%defattr(-,root,root)
%{_libdir}/slurm/auth_none.so
%endif

%if %(test -f %{_libdir}/slurm/auth_munge.so && echo 1 || echo 0)
%files auth-munge
%defattr(-,root,root)
%{_libdir}/slurm/auth_munge.so
%endif

%if %(test -f %{_libdir}/slurm/auth_authd.so && echo 1 || echo 0)
%files auth-authd
%defattr(-,root,root)
%{_libdir}/slurm/auth_authd.so
%endif

%pre
if [ -x /etc/rc.d/init.d/slurm ]; then
    if /etc/rc.d/init.d/slurm status | grep -q running; then
        /etc/rc.d/init.d/slurm stop
    fi
fi

%post
/sbin/ldconfig %{_libdir}
if [ -x /etc/rc.d/init.d/slurm ]; then
    [ -x /sbin/chkconfig ] && /sbin/chkconfig --del slurm
    [ -x /sbin/chkconfig ] && /sbin/chkconfig --add slurm
    if ! /etc/rc.d/init.d/slurm status | grep -q running; then
        /etc/rc.d/init.d/slurm start
    fi
fi

%preun
if [ "$1" = 0 ]; then
    if [ -x /etc/rc.d/init.d/slurm ]; then
        [ -x /sbin/chkconfig ] && /sbin/chkconfig --del slurm
        if /etc/rc.d/init.d/slurm status | grep -q running; then
            /etc/rc.d/init.d/slurm stop
        fi
    fi
fi

%postun
if [ "$1" = 0 ]; then
    /sbin/ldconfig %{_libdir}
fi


%changelog
* Sat Jan 26 2003 Joey Ekstrom <jcekstrom@llnl.gov> 
- Started spec file
-
